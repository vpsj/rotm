<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RailFan of the Month</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== EXISTING STYLES (UNCHANGED) ===== */
body {
  margin: 0;
  background: #0f1115;
  color: #e6e6e6;
  font-family: system-ui, sans-serif;
}

h1 {
  text-align: center;
  margin-top: 40px;
}

.subtitle {
  max-width: 900px;
  margin: 20px auto 40px;
  text-align: center;
  line-height: 1.6;
  color: #cfd3da;
}

.grid {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 24px;
}

.card {
  background: #1a1f27;
  border-radius: 16px;
  padding: 16px;
  border: 2px solid #ff6b6b;
}

.card h3 {
  margin-top: 0;
}

.video-box {
  width: 100%;
  aspect-ratio: 9 / 16;
  background: #111;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 12px;
}

.video-box iframe,
.video-box video {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}

a.reddit-link {
  color: #4da3ff;
  text-decoration: none;
}

.slider {
  margin-top: 10px;
}

footer {
  text-align: center;
  margin: 40px 0;
}

button {
  background: #4da3ff;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>RailFan of the Month</h1>

<div class="subtitle">
  <strong>Rate the videos based on the following criteria:</strong>
  <ul style="list-style: none; padding-left: 0;">
    <li>â€¢ The video quality and cinematography of the clip</li>
    <li>â€¢ Authentic track sound over low-effort background music</li>
    <li>â€¢ Title of the video, how descriptive and informative it is</li>
  </ul>
  <strong>PS:</strong> You must rate all the videos to submit your votes
</div>

<div id="grid" class="grid"></div>

<footer>
  <button id="submitBtn" disabled>Submit Ratings</button>
  <div id="progress">0 / 0 videos rated</div>
</footer>

<script>
/* ============================================================
   CONFIG (UNCHANGED)
============================================================ */
const JSON_URL = "videos.json"; // your dynamic JSON file

/* ============================================================
   BROWSER DETECTION
============================================================ */
const isChrome =
  /Chrome/.test(navigator.userAgent) &&
  /Google Inc/.test(navigator.vendor);

/* ============================================================
   ===== VIDEO LOADING LOGIC (CHANGED) =====
============================================================ */

async function createVideoElement(redditUrl) {
  const box = document.createElement("div");
  box.className = "video-box";

  if (!isChrome) {
    // ðŸ”¥ FIREFOX: Reddit embed (works perfectly)
    const iframe = document.createElement("iframe");
    iframe.src = redditUrl.replace("www.reddit.com", "embed.reddit.com");
    iframe.allow = "autoplay; fullscreen; picture-in-picture";
    iframe.allowFullscreen = true;
    box.appendChild(iframe);
    return box;
  }

  // ðŸ”¥ CHROME: Fetch Reddit JSON â†’ native <video>
  try {
    const jsonUrl = redditUrl.replace(/\/$/, "") + ".json";
    const res = await fetch(jsonUrl);
    const data = await res.json();
    const post = data[0].data.children[0].data;

    if (!post.media || !post.media.reddit_video) {
      throw new Error("No reddit_video");
    }

    const video = document.createElement("video");
    video.src = post.media.reddit_video.fallback_url;
    video.autoplay = true;
    video.muted = true;
    video.loop = true;
    video.playsInline = true;
    video.controls = true;
    video.preload = "metadata";

    box.appendChild(video);
  } catch (e) {
    box.textContent = "Error loading video";
  }

  return box;
}

/* ============================================================
   PAGE BUILD (UNCHANGED EXCEPT CALLING VIDEO LOGIC)
============================================================ */

const grid = document.getElementById("grid");
const progress = document.getElementById("progress");
const submitBtn = document.getElementById("submitBtn");

const ratings = {};
let totalVideos = 0;

fetch(JSON_URL)
  .then(res => res.json())
  .then(async urls => {
    totalVideos = urls.length;
    progress.textContent = `0 / ${totalVideos} videos rated`;

    for (const url of urls) {
      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("h3");
      title.textContent = "Loading titleâ€¦";

      const videoBox = await createVideoElement(url);

      const link = document.createElement("a");
      link.href = url;
      link.target = "_blank";
      link.className = "reddit-link";
      link.textContent = "View on Reddit";

      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = 1;
      slider.max = 10;
      slider.value = 0;
      slider.className = "slider";

      slider.addEventListener("input", () => {
        ratings[url] = Number(slider.value);
        const done = Object.keys(ratings).length;
        progress.textContent = `${done} / ${totalVideos} videos rated`;
        submitBtn.disabled = done !== totalVideos;
      });

      card.appendChild(title);
      card.appendChild(videoBox);
      card.appendChild(link);
      card.appendChild(slider);

      grid.appendChild(card);
    }
  });
</script>

</body>
</html>
