<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RailFan of the Month</title>

<style>
body{
  margin:0;
  background:#0f1115;
  color:#f1f1f1;
  font-family:system-ui,sans-serif;
}
header{
  text-align:center;
  padding:2rem 1rem;
}
.subtitle{
  max-width:720px;
  margin:auto;
  text-align:left;
  color:#cfd3da;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:1rem;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
  gap:1.4rem;
}
.card{
  background:#1a1f27;
  border-radius:14px;
  padding:1rem;
}
.card.unrated{outline:2px solid #ff6b6b}
.card h3{margin:.3rem 0 .6rem}
.card a{color:#6cb6ff;text-decoration:none;font-size:.9rem}

iframe, video{
  width:100%;
  height:520px;
  border-radius:10px;
  background:#000;
}

.slider-row{
  display:flex;
  gap:.8rem;
  align-items:center;
  margin-top:.6rem;
}
input[type=range]{flex:1}

.rating-bubble{
  width:42px;height:42px;border-radius:50%;
  background:#6cb6ff;color:#000;font-weight:800;
  display:none;align-items:center;justify-content:center
}

.footer{text-align:center;margin:2rem 0}
button{
  background:#6cb6ff;color:#000;
  border:none;border-radius:14px;
  padding:.9rem 2rem;font-weight:800
}
button:disabled{opacity:.5}
</style>
</head>

<body>

<header>
  <h1>RailFan of the Month</h1>
  <div class="subtitle">
    <p><b>Rate the videos based on the following criteria:</b></p>
    <ul>
      <li>The video quality and cinematography of the clip</li>
      <li>Authentic track sound over low-effort background music</li>
      <li>Title of the video, how descriptive and informative it is</li>
    </ul>
    <p><b>PS:</b> You must rate all the videos to submit your votes</p>
  </div>
</header>

<div class="container">
  <div id="grid" class="grid"></div>
  <div class="footer">
    <button id="submit" disabled>Submit Ratings</button>
    <div id="progress">0 / 0 videos rated</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* FIREBASE CONFIG â€” UNCHANGED */
const firebaseConfig = {
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebasestorage.app",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const grid = document.getElementById("grid");
const submit = document.getElementById("submit");
const progress = document.getElementById("progress");

const ratings = {};
let total = 0;

const isChrome = /Chrome/.test(navigator.userAgent) && !/Firefox/.test(navigator.userAgent);

/* ================= VIDEO LOADER ================= */

async function loadVideos(){
  const res = await fetch("links.json");
  const links = await res.json();

  total = links.length;
  progress.textContent = `0 / ${total} videos rated`;

  for(const link of links){
    const card = document.createElement("div");
    card.className = "card unrated";
    grid.appendChild(card);

    try{
      const r = await fetch(link + ".json");
      const j = await r.json();
      const post = j[0].data.children[0].data;
      const id = post.id;

      let mediaHTML = "";

      if(isChrome){
        const mp4 = post.media?.reddit_video?.fallback_url;
        if(!mp4) throw "No MP4";

        mediaHTML = `
          <video
            src="${mp4}"
            autoplay
            muted
            loop
            controls
            playsinline
          ></video>
        `;
      }else{
        const embed =
          `https://www.redditmedia.com${post.permalink}?ref_source=embed&embed=true`;
        mediaHTML = `
          <iframe
            src="${embed}"
            loading="lazy"
            allow="autoplay; fullscreen; picture-in-picture"
          ></iframe>
        `;
      }

      card.innerHTML = `
        <h3>${post.title}</h3>
        ${mediaHTML}
        <a href="${link}" target="_blank">View on Reddit</a>
        <div class="slider-row">
          <input type="range" min="1" max="10" step="1">
          <div class="rating-bubble"></div>
        </div>
      `;

      const slider = card.querySelector("input");
      const bubble = card.querySelector(".rating-bubble");

      slider.addEventListener("input",()=>{
        bubble.style.display="flex";
        bubble.textContent = slider.value;
        ratings[id] = Number(slider.value);
        card.classList.remove("unrated");
        const done = Object.keys(ratings).length;
        progress.textContent = `${done} / ${total} videos rated`;
        submit.disabled = done !== total;
      });

    }catch(e){
      card.innerHTML = `
        <p>Error loading video</p>
        <a href="${link}" target="_blank">View on Reddit</a>
      `;
    }
  }
}

submit.onclick = async ()=>{
  submit.disabled = true;
  await addDoc(collection(db,"votes"),{
    userId:"anon_"+crypto.randomUUID(),
    ratings,
    createdAt:serverTimestamp()
  });
};

loadVideos();
</script>

</body>
</html>
