<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RailFan of the Month</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  background:#0f1115;
  color:#f0f0f0;
  font-family:system-ui,sans-serif;
}
header{text-align:center;padding:2rem 1rem}
ul{max-width:720px;margin:auto;color:#cfd3d7}
.container{max-width:1100px;margin:auto;padding:1rem}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem}
.card{
  background:#1b1f27;
  border:1px solid #2f3542;
  border-radius:14px;
  padding:1rem;
}
.card.unrated{border-color:#ff6b6b}
.card h3{margin:.2rem 0;font-size:1rem;color:#ffffff}
.card a{color:#6fb1ff;text-decoration:none;font-size:.9rem}
.slider-row{display:flex;gap:.8rem;align-items:center;margin-top:.6rem}
input[type=range]{flex:1}
.rating-value{
  width:40px;height:40px;border-radius:50%;
  background:#6fb1ff;color:#000;font-weight:800;
  display:none;align-items:center;justify-content:center
}
.footer{text-align:center;margin:2rem}
button{
  background:#6fb1ff;color:#000;
  border:none;border-radius:12px;
  padding:.8rem 1.6rem;font-weight:700
}
button:disabled{opacity:.4}
</style>
</head>

<body>

<header>
<h1>RailFan of the Month</h1>
<ul>
<li>Rate every video from <b>1 to 10</b></li>
<li>Authentic track sound preferred</li>
<li>You must rate <b>all videos</b> to submit</li>
</ul>
</header>

<div class="container">
  <div id="grid" class="grid"></div>
  <div class="footer">
    <button id="submit" disabled>Submit Ratings</button>
    <div id="progress"></div>
    <div id="msg"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* YOUR REAL CONFIG – UNCHANGED */
const firebaseConfig = {
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebasestorage.app",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const grid=document.getElementById("grid");
const submit=document.getElementById("submit");
const progress=document.getElementById("progress");
const msg=document.getElementById("msg");

const ratings={};
let total=0;

const linksRes = await fetch("https://raw.githubusercontent.com/vpsj/rotm/main/links.json");
const links = await linksRes.json();
total = links.length;
progress.textContent = `0 / ${total} videos rated`;

for (const url of links) {
  const res = await fetch(url + ".json");
  const json = await res.json();
  const post = json[0].data.children[0].data;
  const id = post.id;

  const card=document.createElement("div");
  card.className="card unrated";
  card.innerHTML=`
    <h3>${post.title}</h3>
    <a href="https://redd.it/${id}" target="_blank">View on Reddit</a>
    <div class="slider-row">
      <input type="range" min="1" max="10" step="1">
      <div class="rating-value"></div>
    </div>
  `;

  const slider=card.querySelector("input");
  const bubble=card.querySelector(".rating-value");

  slider.addEventListener("input",()=>{
    bubble.style.display="flex";
    bubble.textContent = slider.value * 10;
    ratings[id] = Number(slider.value) * 10;
    card.classList.remove("unrated");
    const done = Object.keys(ratings).length;
    progress.textContent = `${done} / ${total} videos rated`;
    submit.disabled = done !== total;
  });

  grid.appendChild(card);
}

submit.onclick=async()=>{
  submit.disabled=true;
  msg.textContent="Submitting...";
  await addDoc(collection(db,"votes"),{
    userId:"anon_"+crypto.randomUUID(),
    ratings,
    createdAt:serverTimestamp()
  });
  msg.textContent="✅ Ratings submitted";
};
</script>

</body>
</html>
