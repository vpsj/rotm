<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RailFan of the Month</title>

<style>
body{
  margin:0;
  background:#0f1115;
  color:#f1f1f1;
  font-family:system-ui,sans-serif;
}

header{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}

h1{margin-bottom:.8rem}

.subtitle{
  max-width:720px;
  margin:auto;
  text-align:left
}

.subtitle ul{
  list-style-position:inside;
  color:#cfd3da
}

.container{
  max-width:1200px;
  margin:auto;
  padding:1rem
}

/* ===== MASONRY GRID FIX ===== */
.grid {
  display: block; 
  columns: 3 320px; 
  column-gap: 2rem;
}

.card{
  break-inside: avoid;
  margin-bottom: 2rem;
  background:#1a1f27;
  border-radius:14px;
  padding:1rem;
  box-shadow:0 6px 18px rgba(0,0,0,.45);
  display:flex;
  flex-direction:column
}

.card h3{
  margin:.2rem 0 .8rem;
  font-size:1rem;
  line-height:1.4;
  font-weight:600;
  word-break:break-word
}

.card a{
  color:#6cb6ff;
  text-decoration:none;
  font-size:.9rem;
  margin:.6rem 0
}

.video-wrap{
  width:100%;
  background:#000;
  border-radius:8px;
}

.video-wrap iframe{
  width:100%;
  height:20vh;        /* smaller than before */
  min-height:280px;  /* safe for landscape */
  max-height:520px;  /* prevents absurd tall cards */
  border:0;
  display:block;
}

/* Global scrollbar nuking */
iframe {
  scrollbar-width: none !important;
}
iframe::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
}

/* RATING */
.slider-row{
  display:flex;
  align-items:center;
  gap:.8rem;
  margin-top:.8rem;
}

input[type=range]{flex:1}

.rating-bubble{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#6cb6ff;
  color:#000;
  font-weight:800;
  display:none;
  align-items:center;
  justify-content:center
}

.card.unrated{outline:2px solid #ff6b6b}

.footer{
  text-align:center;
  margin:2.5rem 0;
  clear: both;
}

button{
  background:#6cb6ff;
  color:#000;
  border:none;
  border-radius:14px;
  padding:.9rem 2rem;
  font-weight:800;
  font-size:1rem
}

button:disabled{opacity:.5}

#progress{margin-top:.8rem;color:#cfd3da}
#msg{margin-top:.6rem;font-weight:700}
</style>
</head>

<body>

<header>
  <h1>RailFan of the Month</h1>
  <div class="subtitle">
    <p><b>Rate the videos based on the following criteria:</b></p>
    <ul>
      <li>The video quality and cinematography of the clip</li>
      <li>Authentic track sound over low-effort background music</li>
      <li>Title of the video, how descriptive and informative it is</li>
    </ul>
    <p><b>PS:</b> You must rate all the videos to submit your votes</p>
  </div>
</header>

<div class="container">
  <div id="grid" class="grid"></div>
  <div class="footer">
    <button id="submit" disabled>Submit Ratings</button>
    <div id="progress">0 / 0 videos rated</div>
    <div id="msg"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

initializeApp({
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebaseapp.com",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9"
});

const db = getFirestore();
const grid = document.getElementById("grid");
const submit = document.getElementById("submit");
const progress = document.getElementById("progress");
const msg = document.getElementById("msg");

const ratings = {};
let total = 0;

async function loadVideos(){
  const res = await fetch(
    "https://raw.githubusercontent.com/vpsj/rotm/main/links.json",
    { cache:"no-store" }
  );
  const urls = await res.json();

  total = urls.length;
  progress.textContent = `0 / ${total} videos rated`;

  for(const url of urls){
    const clean = url.replace(/\/$/,"").split("/");
    const postId = clean[clean.indexOf("comments")+1];
    const slug = clean[clean.indexOf("comments")+2] || "";

    const title = slug
      .replace(/[_-]/g," ")
      .replace(/\b\w/g,c=>c.toUpperCase());

    const card = document.createElement("div");
    card.className = "card unrated";

    card.innerHTML = `
      <h3>${title}</h3>
      <div class="video-wrap">
        <iframe
  src="https://www.reddit.com/mediaembed/${postId}?autoplay=1&muted=1"
  allow="autoplay; fullscreen"
  scrolling="no">
</iframe>

      </div>
      <a href="${url}" target="_blank">View on Reddit</a>
      <div class="slider-row">
        <input type="range" min="1" max="10">
        <div class="rating-bubble"></div>
      </div>
    `;

    grid.appendChild(card);
    const iframe = card.querySelector("iframe");

/* Dynamic aspect-ratio resolver */
iframe.addEventListener("load", () => {
  try {
    const w = iframe.offsetWidth;

    /* Default fallback */
    let ratio = 16 / 9;

    /* Heuristic based on embed height */
    setTimeout(() => {
      const h = iframe.contentWindow?.document?.body?.scrollHeight;

      if (h) {
        ratio = w / h;
      }

      /* Portrait vs landscape correction */
      if (ratio < 1) {
        card.querySelector(".video-wrap").style.aspectRatio = "9 / 16";
      } else {
        card.querySelector(".video-wrap").style.aspectRatio = "16 / 9";
      }
    }, 300);
  } catch {
    /* Silent fail – fallback ratio remains */
    card.querySelector(".video-wrap").style.aspectRatio = "16 / 9";
  }
});


    const slider = card.querySelector("input");
    const bubble = card.querySelector(".rating-bubble");

    slider.addEventListener("input",()=>{
      ratings[postId] = Number(slider.value);
      bubble.style.display="flex";
      bubble.textContent = slider.value;
      card.classList.remove("unrated");

      const done = Object.keys(ratings).length;
      progress.textContent = `${done} / ${total} videos rated`;
      submit.disabled = done !== total;
    });
  }
}

window.addEventListener("message", e => {
  let h = null;

  // Reddit sends different shapes depending on embed version
  if (typeof e.data === "object") {
    if (typeof e.data.height === "number") {
      h = e.data.height;
    } else if (e.data.data && typeof e.data.data.height === "number") {
      h = e.data.data.height;
    }
  }

  if (!h) return;

  document.querySelectorAll("iframe").forEach(f => {
    if (f.contentWindow === e.source) {
      // Portrait embeds are much taller internally
      if (h > 650) {
        f.style.height = "40vh";   // portrait
      } else {
        f.style.height = "20vh";   // landscape
      }
    }
  });
});


submit.onclick = async ()=>{
  submit.disabled = true;
  msg.textContent = "Submitting…";
  await addDoc(collection(db,"votes"),{
    userId:"anon_"+crypto.randomUUID(),
    ratings,
    createdAt:serverTimestamp()
  });
  msg.textContent = "✅ Votes submitted successfully";
};

loadVideos();
</script>

</body>
</html>
