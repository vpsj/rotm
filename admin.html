<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROTM Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f1115;
  --card:#1a1f2b;
  --text:#e6e9ef;
  --muted:#b8c0cc;
  --accent:#4f8cff;
  --gold:#7a6a32;
  --silver:#5f636b;
  --bronze:#6b4a32;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
.container{max-width:1200px;margin:auto;padding:24px}
h1{text-align:center;margin-bottom:6px}
.sub{text-align:center;color:var(--muted);margin-bottom:20px}
.tabs{text-align:center;margin-bottom:20px}
button{
  border:none;
  padding:10px 14px;
  border-radius:6px;
  background:#2a3140;
  color:#fff;
  margin:4px;
  cursor:pointer;
}
button.primary{background:var(--accent)}
button.danger{background:#c0392b}
button:disabled{opacity:.5}
.card{
  background:var(--card);
  border-radius:10px;
  padding:16px;
  margin-bottom:24px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:12px;
  text-align:left;
  vertical-align:top;
}
th{color:#fff;border-bottom:1px solid #2e3445}
td{border-bottom:1px solid #2e3445}
tr.top1{background:var(--gold)}
tr.top2{background:var(--silver)}
tr.top3{background:var(--bronze)}
a{color:#7fb0ff;text-decoration:none}
a:hover{text-decoration:underline}
.hidden{display:none}
textarea{
  width:100%;
  min-height:260px;
  background:#0c0f15;
  color:#f0f3fa;
  border:1px solid #2e3445;
  border-radius:8px;
  padding:12px;
  font-family:monospace;
  font-size:14px;
}
</style>
</head>

<body>
<div class="container">
<h1>ROTM Admin Dashboard</h1>
<div class="sub" id="userEmail"></div>

<div class="tabs">
  <button class="primary" id="scoresTabBtn">Scores</button>
  <button id="statsTabBtn">Detailed Votes & Stats</button>
  <button class="danger" id="resetBtn">Reset All Votes</button>
  <button id="logoutBtn">Logout</button>
</div>

<!-- SCORES -->
<div id="scoresTab" class="card">
<table>
<thead>
<tr>
<th>Rank</th>
<th>Video</th>
<th>Reddit Upvotes</th>
<th>Upvote Points</th>
<th>Vote Points</th>
<th>Total</th>
</tr>
</thead>
<tbody id="scoresBody"></tbody>
</table>

<h3 style="margin-top:24px">Reddit Post Template</h3>
<textarea id="templateBox" readonly></textarea>
<br><br>
<button onclick="copyTemplate()">Copy Template</button>
</div>

<!-- STATS -->
<div id="statsTab" class="card hidden">
<table>
<thead>
<tr>
<th>User</th>
<th>Video #</th>
<th>Rating</th>
<th>Time</th>
</tr>
</thead>
<tbody id="statsBody"></tbody>
</table>
<br>
<button onclick="exportCSV()">Export Votes to CSV</button>
</div>

</div>

<script>
/* ===== FIREBASE CONFIG (UNCHANGED) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebasestorage.app",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9",
  measurementId: "G-P3H0NR73MD"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

/* ===== AUTH ===== */
auth.onAuthStateChanged(u=>{
  if(!u) return;
  document.getElementById("userEmail").textContent="Signed in as "+u.email;
  loadData();
});

/* ===== DATA ===== */
let videos={},votes=[];

/* ===== TABS ===== */
scoresTabBtn.onclick=()=>{
  scoresTab.classList.remove("hidden");
  statsTab.classList.add("hidden");
};
statsTabBtn.onclick=()=>{
  statsTab.classList.remove("hidden");
  scoresTab.classList.add("hidden");
};

/* ===== LOAD ===== */
function loadData(){
  db.collection("videos").onSnapshot(s=>{
    videos={};
    s.forEach(d=>videos[d.id]={id:d.id,...d.data(),votePoints:0,upvotePoints:0,total:0});
    calculate();
  });
  db.collection("votes").onSnapshot(s=>{
    votes=s.docs.map(d=>({id:d.id,...d.data()}));
    calculate();
    renderStats();
  });
}

/* ===== CALCULATE ===== */
function calculate(){
  if(!Object.keys(videos).length) return;
  Object.values(videos).forEach(v=>{v.votePoints=0});
  votes.forEach(v=>{
    if(v.ratings){
      Object.entries(v.ratings).forEach(([id,r])=>{
        if(videos[id]) videos[id].votePoints+=r*10;
      });
    }
  });
  const sortedUp=[...Object.values(videos)].sort((a,b)=>a.upvotes-b.upvotes);
  sortedUp.forEach((v,i)=>v.upvotePoints=(i+1)*10);
  Object.values(videos).forEach(v=>v.total=v.votePoints+v.upvotePoints);
  renderScores();
  renderTemplate();
}

/* ===== RENDER SCORES ===== */
function renderScores(){
  const tbody=document.getElementById("scoresBody");
  tbody.innerHTML="";
  const sorted=[...Object.values(videos)].sort((a,b)=>b.total-a.total);
  sorted.forEach((v,i)=>{
    const tr=document.createElement("tr");
    if(i===0)tr.classList.add("top1");
    if(i===1)tr.classList.add("top2");
    if(i===2)tr.classList.add("top3");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><a href="${v.redditUrl}" target="_blank">${v.title}</a></td>
      <td>${v.upvotes}</td>
      <td>${v.upvotePoints}</td>
      <td>${v.votePoints}</td>
      <td><b>${v.total}</b></td>`;
    tbody.appendChild(tr);
  });
}

/* ===== TEMPLATE ===== */
function renderTemplate(){
  const sorted=[...Object.values(videos)].sort((a,b)=>b.total-a.total);
  if(!sorted.length) return;
  const winner=sorted[0];
  const others=sorted.slice(1,4);
  templateBox.value=
`Title: ✨ RailFan of the Month for [Month][Year] goes to ‘${winner.author}’ for this “${winner.title}”! ✨
As a Reward, they receive a Special Flair + An entry into our ROTM Hall of Fame! [Details in Comments]

---

**Mod Comment:**

Congratulations to u/${winner.author} for becoming the [Month][Year] RailFan of the Month!

If you also wish to see your name immortalized in the [ROTM Hall Of Fame](https://www.reddit.com/r/indianrailways/wiki/hof), get a mention in the sidebar of the subreddit, AND receive a [special flair](https://i.imgur.com/rJCJGMg.png) courtesy of the mods, just go through the [ROTM rules](https://www.reddit.com/r/indianrailways/wiki/rotm) and submit your own beautiful videos of Indian Railways!

Here are some of the other videos loved by both mods and the subreddit that missed out (competition was quite close this time):

${others.map(v=>`* [${v.title}](${v.redditUrl}) by u/${v.author}`).join("\n")}

Congratulations again to the Winner and the runner-ups. The contest will run every month so all the wonderful RailFans of our sub will have plenty of chance to win!

- r/IndianRailways ModTeam`;
}

/* ===== STATS ===== */
function renderStats(){
  const tb=document.getElementById("statsBody");
  tb.innerHTML="";
  votes.forEach(v=>{
    if(!v.ratings) return;
    Object.entries(v.ratings).forEach(([vid,r])=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${v.id.slice(0,8)}</td>
        <td>${Object.keys(videos).indexOf(vid)+1}</td>
        <td>${r}</td>
        <td>${new Date(v.timestamp?.toDate?.()||Date.now()).toLocaleString()}</td>`;
      tb.appendChild(tr);
    });
  });
}

/* ===== ACTIONS ===== */
function copyTemplate(){navigator.clipboard.writeText(templateBox.value)}
function exportCSV(){
  let csv="User,Video,Rating,Time\n";
  votes.forEach(v=>{
    Object.entries(v.ratings||{}).forEach(([vid,r])=>{
      csv+=`${v.id},${vid},${r},${new Date(v.timestamp?.toDate?.()).toISOString()}\n`;
    });
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="votes.csv";
  a.click();
}
resetBtn.onclick=()=>db.collection("votes").get().then(s=>s.forEach(d=>d.ref.delete()));
logoutBtn.onclick=()=>auth.signOut();
</script>
</body>
</html>
