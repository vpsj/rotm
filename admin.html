<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROTM Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;background:#0f1115;color:#e6e6e6;font-family:system-ui}
header{text-align:center;padding:24px}
.actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
button{padding:10px 16px;border:none;border-radius:6px;font-weight:600}
.primary{background:#3b82f6;color:#fff}
.secondary{background:#374151;color:#fff}
.danger{background:#dc2626;color:#fff}
.container{max-width:1200px;margin:auto;padding:16px}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #1f2937;text-align:center}
td.title{text-align:left;word-break:break-word}
td.title a{color:#cfe0ff;text-decoration:none}
.top1{background:#6f6228}
.top2{background:#5a5e66}
.top3{background:#70452a}
textarea{width:100%;min-height:360px;background:#0f1115;color:#e6e6e6;border:1px solid #1f2937;border-radius:8px;padding:12px}
</style>
</head>

<body>

<header>
<h1>ROTM Admin Dashboard</h1>
<div id="userInfo">Checking authentication…</div>
<div class="actions">
<button id="scoresBtn" class="primary">Scores</button>
<button id="resetBtn" class="danger">Reset All Votes</button>
<button onclick="logout()" class="secondary">Logout</button>
</div>
</header>

<div class="container">
<table>
<thead>
<tr>
<th>Rank</th>
<th>Video</th>
<th>Reddit Upvotes</th>
<th>Upvote Points</th>
<th>Vote Points</th>
<th>Total</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<h3 style="margin-top:40px">Reddit Post Template</h3>
<textarea id="template" readonly></textarea>
<button class="secondary" onclick="copyTemplate()">Copy Template</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* EXACT CONFIG – UNCHANGED */
const firebaseConfig = {
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebasestorage.app",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9",
  measurementId: "G-P3H0NR73MD"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

const ADMIN=["vpsjdon@gmail.com"];

onAuthStateChanged(auth,async u=>{
  if(!u){await signInWithPopup(auth,provider);return}
  if(!ADMIN.includes(u.email)){alert("Denied");signOut(auth);return}
  userInfo.textContent="Signed in as "+u.email;
  init();
});

const videosCol=collection(db,"videos");
const votesCol=collection(db,"votes");
let videos={},votes=[];

function init(){
  onSnapshot(videosCol,s=>{
    videos={};
    s.docs.forEach(d=>videos[d.id]={...d.data(),votePoints:0,upvotePoints:0,total:0});
    calc();
  });
  onSnapshot(votesCol,s=>{
    votes=s.docs.map(d=>d.data());
    calc();
  });
}

function calc(){
  Object.values(videos).forEach(v=>{v.votePoints=0;v.upvotePoints=0;v.total=0});

  votes.forEach(v=>{
    Object.entries(v.ratings||{}).forEach(([id,r])=>{
      if(videos[id]) videos[id].votePoints+=r*10;
    });
  });

  const sortedUp=Object.entries(videos).sort((a,b)=>b[1].upvotes-a[1].upvotes);
  sortedUp.forEach(([id],i)=>videos[id].upvotePoints=(sortedUp.length-i)*10);

  Object.values(videos).forEach(v=>v.total=v.votePoints+v.upvotePoints);
  render();
}

function render(){
  tbody.innerHTML="";
  const sorted=Object.entries(videos).sort((a,b)=>b[1].total-a[1].total);
  sorted.forEach(([id,v],i)=>{
    const tr=document.createElement("tr");
    if(i===0)tr.className="top1";
    else if(i===1)tr.className="top2";
    else if(i===2)tr.className="top3";
    tr.innerHTML=`
      <td>${i+1}</td>
      <td class="title"><a href="${v.redditUrl}" target="_blank">${v.title}</a></td>
      <td>${v.upvotes}</td>
      <td>${v.upvotePoints}</td>
      <td>${v.votePoints}</td>
      <td><b>${v.total}</b></td>`;
    tbody.appendChild(tr);
  });
}

window.copyTemplate=()=>navigator.clipboard.writeText(template.value);
window.resetBtn.onclick=async()=>{
  if(!confirm("Reset all votes?"))return;
  const s=await getDocs(votesCol);
  for(const d of s.docs) await deleteDoc(d.ref);
};
window.logout=()=>signOut(auth);
</script>

</body>
</html>
