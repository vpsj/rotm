<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROTM Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f1115;
  --card:#1a1f2b;
  --text:#e6e9ef;
  --muted:#b8c0cc;
  --accent:#4f8cff;
  --gold:#7a6a32;
  --silver:#5f636b;
  --bronze:#6b4a32;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
.container{max-width:1200px;margin:auto;padding:24px}
h1{text-align:center;margin-bottom:6px}
.sub{text-align:center;color:var(--muted);margin-bottom:20px}
.tabs{text-align:center;margin-bottom:20px}
button{
  border:none;
  padding:10px 14px;
  border-radius:6px;
  background:#2a3140;
  color:#fff;
  margin:4px;
  cursor:pointer;
}
button.primary{background:var(--accent)}
button.danger{background:#c0392b}
button.warn{background:#f39c12;color:#000}
button:disabled{opacity:.5}
.card{
  background:var(--card);
  border-radius:10px;
  padding:16px;
  margin-bottom:24px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:12px;
  text-align:left;
  vertical-align:top;
}
th{border-bottom:1px solid #2e3445}
td{border-bottom:1px solid #2e3445}
tr.top1{background:var(--gold)}
tr.top2{background:var(--silver)}
tr.top3{background:var(--bronze)}
a{color:#7fb0ff;text-decoration:none}
.hidden{display:none}
textarea{
  width:100%;
  min-height:260px;
  background:#0c0f15;
  color:#f0f3fa;
  border:1px solid #2e3445;
  border-radius:8px;
  padding:12px;
  font-family:monospace;
}
</style>
</head>

<body>
<div class="container">
<h1>ROTM Admin Dashboard</h1>
<div class="sub" id="userEmail"></div>

<div class="tabs">
  <button class="primary" id="scoresTabBtn">Scores</button>
  <button id="statsTabBtn">Detailed Votes & Stats</button>
  <button class="warn" id="refreshVideosBtn">Update Videos from links.json</button>
  <button class="danger" id="resetBtn">Reset All Votes</button>
  <button id="logoutBtn">Logout</button>
</div>

<div id="scoresTab" class="card">
<table>
<thead>
<tr>
<th>Rank</th>
<th>Video</th>
<th>Reddit Upvotes</th>
<th>Upvote Points</th>
<th>Vote Points</th>
<th>Total</th>
</tr>
</thead>
<tbody id="scoresBody"></tbody>
</table>

<h3 style="margin-top:24px">Reddit Post Template</h3>
<textarea id="templateBox" readonly></textarea>
<br><br>
<button onclick="copyTemplate()">Copy Template</button>
</div>

<!-- ===================== STATS TAB (ONLY MODIFIED SECTION) ===================== -->
<div id="statsTab" class="card hidden">

<h3>User Voting Log</h3>
<table>
<thead>
<tr>
<th>User</th>
<th>Voted At</th>
</tr>
</thead>
<tbody id="userLogBody"></tbody>
</table>

<h3 style="margin-top:32px">Rating Distribution</h3>
<canvas id="ratingDistChart" height="120"></canvas>

<h3 style="margin-top:32px">Average Rating per Video</h3>
<canvas id="avgRatingChart" height="160"></canvas>

</div>
<!-- =========================================================================== -->

</div>

<script>
/* ================= FIREBASE CONFIG (UNCHANGED) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebasestorage.app",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const LINKS_JSON = "https://raw.githubusercontent.com/vpsj/rotm/main/links.json";

const scoresTab = document.getElementById("scoresTab");
const statsTab = document.getElementById("statsTab");
const scoresBody = document.getElementById("scoresBody");
const templateBox = document.getElementById("templateBox");
const userLogBody = document.getElementById("userLogBody");

let videos = {};
let votes = [];

auth.onAuthStateChanged(u=>{
  if(!u) return;
  userEmail.textContent = "Signed in as " + u.email;
  loadData();
});

scoresTabBtn.onclick=()=>{scoresTab.classList.remove("hidden");statsTab.classList.add("hidden")}
statsTabBtn.onclick=()=>{statsTab.classList.remove("hidden");scoresTab.classList.add("hidden")}

/* ============ REDDIT HELPERS ============ */
function sentenceCase(str){
  return str.replace(/\b\w/g,c=>c.toUpperCase());
}

function extractPostMeta(url){
  const parts = url.replace(/\/$/,"").split("/");
  const id = parts[parts.indexOf("comments")+1];
  const slug = parts[parts.indexOf("comments")+2] || "untitled";
  return {
    id,
    title: sentenceCase(slug.replace(/[_-]/g," ")),
    redditUrl: url
  };
}

async function fetchRedditData(url){
  const res = await fetch(url + ".json");
  const j = await res.json();
  const post = j[0].data.children[0].data;
  return {
    upvotes: post.ups || 0,
    author: post.author || "unknown"
  };
}

/* ============ UPDATE VIDEOS BUTTON (UNCHANGED) ============ */
async function refreshVideos(){
  if(!confirm("This will replace ALL videos with latest links.json. Continue?")) return;

  const res = await fetch(LINKS_JSON,{cache:"no-store"});
  const urls = await res.json();

  const batch = db.batch();
  const old = await db.collection("videos").get();
  old.forEach(d=>batch.delete(d.ref));

  for(const url of urls){
    const meta = extractPostMeta(url);
    const reddit = await fetchRedditData(url);

    batch.set(db.collection("videos").doc(meta.id),{
      title: meta.title,
      redditUrl: url,
      upvotes: reddit.upvotes,
      author: reddit.author
    });
  }

  await batch.commit();
  alert("Videos updated from links.json");
}
refreshVideosBtn.onclick = refreshVideos;

/* ============ LOAD + CALCULATE (UNCHANGED) ============ */
function loadData(){
  db.collection("videos").onSnapshot(s=>{
    videos = {};
    s.forEach(d=>videos[d.id]={id:d.id,...d.data(),votePoints:0,upvotePoints:0,total:0});
    calculate();
  });
  db.collection("votes").onSnapshot(s=>{
    votes = s.docs.map(d=>d.data());
    calculate();
    renderStats();
  });
}

function calculate(){
  Object.values(videos).forEach(v=>v.votePoints=0);

  votes.forEach(v=>{
    Object.entries(v.ratings||{}).forEach(([id,r])=>{
      if(videos[id]) videos[id].votePoints += r*10;
    });
  });

  const sortedByUpvotes=[...Object.values(videos)].sort((a,b)=>a.upvotes-b.upvotes);
  sortedByUpvotes.forEach((v,i)=>v.upvotePoints=(i+1)*10);
  Object.values(videos).forEach(v=>v.total=v.votePoints+v.upvotePoints);

  renderScores();
  renderTemplate();
}

function renderScores(){
  scoresBody.innerHTML="";
  const sorted=[...Object.values(videos)].sort((a,b)=>b.total-a.total);
  sorted.forEach((v,i)=>{
    const tr=document.createElement("tr");
    if(i===0)tr.classList.add("top1");
    if(i===1)tr.classList.add("top2");
    if(i===2)tr.classList.add("top3");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><a href="${v.redditUrl}" target="_blank">${v.title}</a></td>
      <td>${v.upvotes}</td>
      <td>${v.upvotePoints}</td>
      <td>${v.votePoints}</td>
      <td><b>${v.total}</b></td>`;
    scoresBody.appendChild(tr);
  });
}

function renderTemplate(){
  const sorted=[...Object.values(videos)].sort((a,b)=>b.total-a.total);
  if(!sorted.length) return;

  const winner=sorted[0];
  const others=sorted.slice(1,4);

  templateBox.value =
`Title: ✨ RailFan of the Month for [Month][Year] goes to u/${winner.author} for “${winner.title}” ✨

Here are some of the other videos loved by both mods and the subreddit:

${others.map(v=>`* [${v.title}](${v.redditUrl}) by u/${v.author}`).join("\n")}`;
}

/* ===================== NEW STATS LOGIC ONLY ===================== */
let ratingDistChart, avgRatingChart;

function renderStats(){
  userLogBody.innerHTML="";

  votes.forEach(v=>{
    const tr=document.createElement("tr");
    const ts = v.timestamp?.seconds
      ? new Date(v.timestamp.seconds * 1000).toLocaleString()
      : "";
    tr.innerHTML=`<td>${v.userId||"anon"}</td><td>${ts}</td>`;
    userLogBody.appendChild(tr);
  });

  const ratingBuckets = {};
  const perVideo = {};

  votes.forEach(v=>{
    Object.entries(v.ratings||{}).forEach(([vid,r])=>{
      ratingBuckets[r]=(ratingBuckets[r]||0)+1;
      if(!perVideo[vid]) perVideo[vid]={sum:0,count:0};
      perVideo[vid].sum+=r;
      perVideo[vid].count++;
    });
  });

  const distLabels = Object.keys(ratingBuckets).sort((a,b)=>a-b);
  const distValues = distLabels.map(r=>ratingBuckets[r]);

  if(ratingDistChart) ratingDistChart.destroy();
  ratingDistChart = new Chart(
    document.getElementById("ratingDistChart"),
    {
      type:"bar",
      data:{labels:distLabels,datasets:[{label:"Votes",data:distValues}]},
      options:{plugins:{legend:{display:false}}}
    }
  );

  const videoIds = Object.keys(perVideo);
  const videoLabels = videoIds.map(id=>videos[id]?.title||id);
  const avgValues = videoIds.map(id=>(perVideo[id].sum/perVideo[id].count).toFixed(2));

  if(avgRatingChart) avgRatingChart.destroy();
  avgRatingChart = new Chart(
    document.getElementById("avgRatingChart"),
    {
      type:"bar",
      data:{labels:videoLabels,datasets:[{label:"Average Rating",data:avgValues}]},
      options:{indexAxis:"y"}
    }
  );
}
/* ================================================================= */

copyTemplate=()=>navigator.clipboard.writeText(templateBox.value);
resetBtn.onclick=()=>db.collection("votes").get().then(s=>s.forEach(d=>d.ref.delete()));
logoutBtn.onclick=()=>auth.signOut();
</script>
</body>
</html>
