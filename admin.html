<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ROTM Admin Dashboard</title>

<style>
:root {
  --bg: #0f1115;
  --card: #181b22;
  --text: #e6e6e6;
  --muted: #9aa0a6;
  --accent: #4da3ff;
  --gold: #d4af37;
  --silver: #c0c0c0;
  --bronze: #cd7f32;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  padding: 1rem;
  text-align: center;
  font-size: 1.4rem;
  font-weight: 600;
}

#authStatus {
  text-align: center;
  margin: 1rem 0;
}

button {
  background: var(--accent);
  border: none;
  color: #fff;
  padding: 0.6rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95rem;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 1rem;
}

.card {
  background: var(--card);
  border-radius: 10px;
  padding: 1rem;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

th, td {
  padding: 0.6rem;
  border-bottom: 1px solid #2a2f3a;
  text-align: center;
}

th {
  color: var(--muted);
  font-weight: 600;
}

tr.top1 { background: rgba(212,175,55,0.15); }
tr.top2 { background: rgba(192,192,192,0.15); }
tr.top3 { background: rgba(205,127,50,0.15); }

.mobile-scroll {
  overflow-x: auto;
}

@media (max-width: 700px) {
  table {
    font-size: 0.8rem;
  }
}
</style>
</head>

<body>
<header>ROTM Admin Dashboard</header>

<div id="authStatus">Checking authentication...</div>
<div style="text-align:center;">
  <button id="loginBtn" style="display:none;">Login with Google</button>
</div>

<div id="adminContent" style="display:none;" class="container">
  <div class="card mobile-scroll">
    <table id="rankingTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Video</th>
          <th>Reddit<br>Upvotes</th>
          <th>Upvote<br>Points</th>
          <th>Rating<br>Points</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDGqbsUyj9CJq6NmaLR7jP14mHygnuQFDc",
  authDomain: "rotm-rating.firebaseapp.com",
  projectId: "rotm-rating",
  storageBucket: "rotm-rating.firebasestorage.app",
  messagingSenderId: "219038953244",
  appId: "1:219038953244:web:fee4db5c59ed2909e294d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const adminEmails = ["vpsjdon@gmail.com"];

const authStatus = document.getElementById("authStatus");
const loginBtn = document.getElementById("loginBtn");
const adminContent = document.getElementById("adminContent");
const tbody = document.querySelector("#rankingTable tbody");

/* Auth */
loginBtn.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    alert("Login failed");
    console.error(e);
  }
};

onAuthStateChanged(auth, user => {
  if (!user) {
    authStatus.textContent = "Please log in to continue.";
    loginBtn.style.display = "inline-block";
    adminContent.style.display = "none";
    return;
  }

  if (!adminEmails.includes(user.email)) {
    authStatus.textContent = "Access denied.";
    adminContent.style.display = "none";
    return;
  }

  authStatus.textContent = "Signed in as " + user.email;
  loginBtn.style.display = "none";
  adminContent.style.display = "block";
  initDashboard();
});

/* Dashboard logic */
function initDashboard() {
  const videosCol = collection(db, "videos");
  const votesCol = collection(db, "votes");

  let videos = {};
  let votes = [];

  onSnapshot(videosCol, snap => {
    videos = {};
    snap.forEach(d => {
      videos[d.id] = {
        ...d.data(),
        upvotePoints: 0,
        votePoints: 0,
        total: 0
      };
    });
    recalc();
  });

  onSnapshot(votesCol, snap => {
    votes = snap.docs.map(d => d.data());
    recalc();
  });

  function recalc() {
    if (Object.keys(videos).length === 0) return;

    /* Reset */
    Object.values(videos).forEach(v => {
      v.upvotePoints = 0;
      v.votePoints = 0;
      v.total = 0;
    });

    /* Rating points */
    votes.forEach(vote => {
      if (!vote.ratings) return;
      for (const [vid, rating] of Object.entries(vote.ratings)) {
        if (videos[vid]) {
          videos[vid].votePoints += rating * 10;
        }
      }
    });

    /* Upvote points (rank-based) */
    const sortedByUpvotes = Object.values(videos)
      .sort((a, b) => b.upvotes - a.upvotes);

    const step = 10;
    sortedByUpvotes.forEach((v, i) => {
      v.upvotePoints = step * (sortedByUpvotes.length - i);
    });

    /* Total */
    Object.values(videos).forEach(v => {
      v.total = v.votePoints + v.upvotePoints;
    });

    render();
  }

  function render() {
    tbody.innerHTML = "";

    const sorted = Object.entries(videos)
      .sort((a, b) => b[1].total - a[1].total);

    sorted.forEach(([id, v], i) => {
      const tr = document.createElement("tr");
      if (i === 0) tr.classList.add("top1");
      if (i === 1) tr.classList.add("top2");
      if (i === 2) tr.classList.add("top3");

      tr.innerHTML = `
        <td>${i + 1}</td>
        <td style="text-align:left;">
          <a href="${v.redditUrl}" target="_blank" style="color:#4da3ff;text-decoration:none;">
            ${v.title}
          </a>
        </td>
        <td>${v.upvotes ?? 0}</td>
        <td>${v.upvotePoints}</td>
        <td>${v.votePoints}</td>
        <td><strong>${v.total}</strong></td>
      `;
      tbody.appendChild(tr);
    });
  }
}
</script>
</body>
</html>
