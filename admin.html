<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROTM Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background: #0f1115;
  color: #e6e6e6;
}

header {
  padding: 24px;
  text-align: center;
}

h1 { margin-bottom: 6px; }
.sub { opacity: 0.7; font-size: 14px; }

.actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 20px 0;
}

button {
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.primary { background: #3b82f6; color: white; }
.secondary { background: #374151; color: white; }
.danger { background: #dc2626; color: white; }

.container {
  max-width: 1200px;
  margin: auto;
  padding: 0 16px 60px;
}

/* TABLE */
.table-wrap {
  background: #141821;
  border-radius: 12px;
  overflow: hidden;
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

th, td {
  padding: 14px;
  text-align: center;
  vertical-align: top;
}

th {
  background: #1c2230;
  font-weight: 700;
  font-size: 13px;
  opacity: 0.85;
}

td.title {
  text-align: left;
  white-space: normal;
  word-break: break-word;
}

tr:not(:last-child) td {
  border-bottom: 1px solid #1f2937;
}

/* RANK STYLES */
.rank-1 { background: linear-gradient(90deg,#7c6f32,#3a3415); }
.rank-2 { background: linear-gradient(90deg,#6b7280,#2c303a); }
.rank-3 { background: linear-gradient(90deg,#7a4a2e,#2f1e14); }

.badge {
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 6px;
}
.gold { background: gold; color: black; }
.silver { background: silver; color: black; }
.bronze { background: #cd7f32; color: black; }

.hidden { display: none; }

/* TEMPLATE */
.template-box {
  background: #141821;
  border-radius: 12px;
  padding: 16px;
  margin-top: 40px;
}

textarea {
  width: 100%;
  min-height: 300px;
  background: #0f1115;
  color: #e6e6e6;
  border: 1px solid #1f2937;
  border-radius: 8px;
  padding: 14px;
  resize: vertical;
  font-family: monospace;
}
</style>
</head>

<body>

<header>
  <h1>ROTM Admin Dashboard</h1>
  <div class="sub" id="userInfo">Checking authenticationâ€¦</div>

  <div class="actions">
    <button class="primary" onclick="showTab('scores')">Scores</button>
    <button class="secondary" onclick="showTab('votes')">Detailed Votes & Stats</button>
    <button class="secondary" onclick="updateFromLinks()">Update Videos from links.json</button>
    <button class="danger" onclick="resetVotes()">Reset All Votes</button>
    <button class="secondary" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

  <!-- SCORES TAB -->
  <div id="scoresTab">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:60px">Rank</th>
            <th>Video</th>
            <th style="width:120px">Reddit<br>Upvotes</th>
            <th style="width:120px">Upvote<br>Points</th>
            <th style="width:120px">Rating<br>Points</th>
            <th style="width:120px">Total<br>Score</th>
          </tr>
        </thead>
        <tbody id="scoresBody"></tbody>
      </table>
    </div>

    <!-- TEMPLATE ON FRONT PAGE -->
    <div class="template-box">
      <h3>Reddit Post Template</h3>
      <textarea id="redditTemplate" readonly></textarea>
      <br><br>
      <button class="secondary" onclick="copyTemplate()">Copy Template</button>
    </div>
  </div>

  <!-- VOTES TAB -->
  <div id="votesTab" class="hidden">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Video</th>
            <th>Rating</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="votesBody"></tbody>
      </table>
    </div>

    <div id="chart" style="height:420px;margin-top:30px;"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDChk83uv5LqXHemAziEHO3YAqEROHjIbo",
  authDomain: "rotm-2a088.firebaseapp.com",
  projectId: "rotm-2a088"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const ADMIN_EMAILS = ["vpsjdon@gmail.com"];

onAuthStateChanged(auth, async user => {
  if (!user) {
    await signInWithPopup(auth, provider);
    return;
  }
  if (!ADMIN_EMAILS.includes(user.email)) {
    alert("Access denied");
    signOut(auth);
    return;
  }
  document.getElementById("userInfo").innerText = "Signed in as " + user.email;
  loadScores();
  loadVotes();
});

window.showTab = tab => {
  document.getElementById("scoresTab").classList.toggle("hidden", tab !== "scores");
  document.getElementById("votesTab").classList.toggle("hidden", tab !== "votes");
};

async function loadScores() {
  const videosSnap = await getDocs(collection(db,"videos"));
  const votesSnap = await getDocs(collection(db,"votes"));

  const ratingMap = {};
  votesSnap.forEach(v=>{
    const d=v.data();
    ratingMap[d.videoId]=(ratingMap[d.videoId]||0)+d.rating;
  });

  const rows=[];
  videosSnap.forEach(v=>{
    const d=v.data();
    const rating=ratingMap[d.id]||0;
    const upvotePoints=Math.round(d.upvotes/10);
    rows.push({...d,rating,upvotePoints,total:rating+upvotePoints});
  });

  rows.sort((a,b)=>b.total-a.total);

  const body=document.getElementById("scoresBody");
  body.innerHTML="";

  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.className=i===0?"rank-1":i===1?"rank-2":i===2?"rank-3":"";
    tr.innerHTML=`
      <td><span class="badge ${i===0?"gold":i===1?"silver":i===2?"bronze":""}">${i+1}</span></td>
      <td class="title"><a href="${r.redditUrl}" target="_blank">${r.title}</a></td>
      <td>${r.upvotes}</td>
      <td>${r.upvotePoints}</td>
      <td>${r.rating}</td>
      <td><b>${r.total}</b></td>
    `;
    body.appendChild(tr);
  });

  buildTemplate(rows);
}

function buildTemplate(rows){
  if(!rows.length) return;
  const winner=rows[0];
  const others=rows.slice(1,4);

  document.getElementById("redditTemplate").value =
`ðŸ† RailFan of the Month ðŸ†

Winner:
**[${winner.title}](${winner.redditUrl})**

Congratulations to u/${winner.op || "OP"} for topping this month's ROTM rankings!

Other close contenders:
${others.map(v=>`â€¢ [${v.title}](${v.redditUrl})`).join("\n")}

â€” r/IndianRailways Mod Team`;
}

window.copyTemplate=()=>{
  navigator.clipboard.writeText(document.getElementById("redditTemplate").value);
  alert("Template copied!");
};

async function loadVotes(){
  const snap=await getDocs(collection(db,"votes"));
  const body=document.getElementById("votesBody");
  body.innerHTML="";
  snap.forEach(v=>{
    const d=v.data();
    body.innerHTML+=`
      <tr>
        <td>${d.userId}</td>
        <td>${d.videoTitle}</td>
        <td>${d.rating}</td>
        <td>${d.createdAt?.toDate().toLocaleString()||""}</td>
      </tr>`;
  });
}

window.resetVotes=async()=>{
  if(!confirm("Delete ALL votes?")) return;
  const snap=await getDocs(collection(db,"votes"));
  for(const d of snap.docs) await deleteDoc(d.ref);
  location.reload();
};

window.updateFromLinks=()=>alert("GitHub Actions handles this.");
window.logout=()=>signOut(auth).then(()=>location.reload());
</script>

</body>
</html>
