<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ROTM Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background: #0f1115;
  color: #e6e6e6;
}

header {
  padding: 24px;
  text-align: center;
}

h1 { margin-bottom: 6px; }
.sub { opacity: 0.7; font-size: 14px; }

.actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 20px 0;
}

button {
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.primary { background: #3b82f6; color: white; }
.secondary { background: #374151; color: white; }
.danger { background: #dc2626; color: white; }

.container {
  max-width: 1200px;
  margin: auto;
  padding: 0 16px 40px;
}

.table-wrap {
  background: #141821;
  border-radius: 12px;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 14px;
  text-align: left;
  white-space: nowrap;
}

th {
  background: #1c2230;
  font-weight: 700;
  font-size: 13px;
  opacity: 0.8;
}

tr:not(:last-child) td {
  border-bottom: 1px solid #1f2937;
}

a { color: #60a5fa; text-decoration: none; }
a:hover { text-decoration: underline; }

/* TOP 3 STYLES */
.rank-1 { background: linear-gradient(90deg, #7c6f32, #3a3415); }
.rank-2 { background: linear-gradient(90deg, #6b7280, #2c303a); }
.rank-3 { background: linear-gradient(90deg, #7a4a2e, #2f1e14); }

.rank-badge {
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 6px;
}

.gold { background: gold; color: black; }
.silver { background: silver; color: black; }
.bronze { background: #cd7f32; color: black; }

.tabs {
  display: flex;
  gap: 12px;
  margin: 30px 0 10px;
}

.tab {
  cursor: pointer;
  opacity: 0.6;
  font-weight: 600;
}

.tab.active { opacity: 1; }

.hidden { display: none; }

#chart { height: 400px; margin-top: 30px; }

.footer-actions {
  margin-top: 30px;
  display: flex;
  justify-content: center;
}
</style>
</head>

<body>

<header>
  <h1>ROTM Admin Dashboard</h1>
  <div class="sub" id="userInfo">Checking authenticationâ€¦</div>

  <div class="actions">
    <button class="primary" onclick="showTab('scores')">Scores</button>
    <button class="secondary" onclick="showTab('votes')">Detailed Votes & Stats</button>
    <button class="secondary" onclick="updateFromLinks()">Update Videos from links.json</button>
    <button class="danger" onclick="resetVotes()">Reset All Votes</button>
    <button class="secondary" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

  <!-- SCORES -->
  <div id="scoresTab">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Video</th>
            <th>Reddit Upvotes</th>
            <th>Upvote Points</th>
            <th>Rating Points</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="scoresBody"></tbody>
      </table>
    </div>
  </div>

  <!-- VOTES -->
  <div id="votesTab" class="hidden">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Video</th>
            <th>Rating</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="votesBody"></tbody>
      </table>
    </div>

    <div id="chart"></div>

    <div class="footer-actions">
      <button class="secondary" onclick="exportCSV()">Export CSV</button>
    </div>
  </div>

</div>

<script>
/* ---------- FIREBASE CONFIG ---------- */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(async user => {
  if (!user) {
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    return;
  }

  document.getElementById("userInfo").innerText =
    "Signed in as " + user.email;

  loadScores();
  loadVotes();
});

/* ---------- UI ---------- */
function showTab(tab) {
  document.getElementById("scoresTab").classList.toggle("hidden", tab !== "scores");
  document.getElementById("votesTab").classList.toggle("hidden", tab !== "votes");
}

/* ---------- SCORES ---------- */
async function loadScores() {
  const videos = await db.collection("videos").get();
  const votes = await db.collection("votes").get();

  const ratingMap = {};
  votes.forEach(v => {
    const d = v.data();
    ratingMap[d.videoId] = (ratingMap[d.videoId] || 0) + d.rating;
  });

  const rows = [];
  videos.forEach(v => {
    const d = v.data();
    const rating = ratingMap[d.id] || 0;
    const upvotePoints = Math.round(d.upvotes / 10);
    const total = upvotePoints + rating;
    rows.push({ ...d, rating, upvotePoints, total });
  });

  rows.sort((a,b)=>b.total-a.total);

  const tbody = document.getElementById("scoresBody");
  tbody.innerHTML = "";

  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.className = i===0?"rank-1":i===1?"rank-2":i===2?"rank-3":"";
    tr.innerHTML = `
      <td>
        <span class="rank-badge ${i===0?"gold":i===1?"silver":i===2?"bronze":""}">
          ${i+1}
        </span>
      </td>
      <td><a href="${r.redditUrl}" target="_blank">${r.title}</a></td>
      <td>${r.upvotes}</td>
      <td>${r.upvotePoints}</td>
      <td>${r.rating}</td>
      <td><b>${r.total}</b></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- VOTES ---------- */
async function loadVotes() {
  const snap = await db.collection("votes").orderBy("createdAt","desc").get();
  const body = document.getElementById("votesBody");
  body.innerHTML = "";

  const chartData = [["Video","Rating"]];

  snap.forEach(v=>{
    const d=v.data();
    body.innerHTML += `
      <tr>
        <td>${d.userId}</td>
        <td>${d.videoTitle}</td>
        <td>${d.rating}</td>
        <td>${d.createdAt?.toDate().toLocaleString()||""}</td>
      </tr>
    `;
    chartData.push([d.videoTitle, d.rating]);
  });

  google.charts.load("current",{packages:["corechart"]});
  google.charts.setOnLoadCallback(()=>{
    const data = google.visualization.arrayToDataTable(chartData);
    const chart = new google.visualization.ColumnChart(document.getElementById("chart"));
    chart.draw(data,{backgroundColor:"transparent",legend:{textStyle:{color:"#fff"}},hAxis:{textStyle:{color:"#fff"}},vAxis:{textStyle:{color:"#fff"}}});
  });
}

/* ---------- ADMIN ACTIONS ---------- */
function resetVotes() {
  if(!confirm("This will DELETE ALL votes. Continue?")) return;
  db.collection("votes").get().then(s=>{
    const batch=db.batch();
    s.forEach(d=>batch.delete(d.ref));
    batch.commit().then(()=>location.reload());
  });
}

function updateFromLinks() {
  alert("Update triggered. GitHub Action will handle fetch.");
}

function exportCSV() {
  window.open("data:text/csv;charset=utf-8," + encodeURIComponent(
    "user,video,rating\n" +
    [...document.querySelectorAll("#votesBody tr")].map(r =>
      [...r.children].map(c=>c.innerText).join(",")
    ).join("\n")
  ));
}

function logout() {
  auth.signOut().then(()=>location.reload());
}
</script>

</body>
</html>
